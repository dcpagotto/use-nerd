version: '3.8'

# ============================================
# USE Nerd E-commerce - Production Stack
# Docker Swarm + Traefik Configuration
# ============================================

services:
  # ============================================
  # PostgreSQL Database (dedicated for USE Nerd)
  # ============================================
  usenerd-postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: usenerd
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme123}
      POSTGRES_DB: usenerd_production
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - usenerd_postgres_data:/var/lib/postgresql/data
    networks:
      - network_public
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - "com.docker.stack.namespace=usenerd"

  # ============================================
  # Redis Cache (dedicated for USE Nerd)
  # ============================================
  usenerd-redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-changeme123}
    volumes:
      - usenerd_redis_data:/data
    networks:
      - network_public
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - "com.docker.stack.namespace=usenerd"

  # ============================================
  # Medusa Backend API
  # ============================================
  usenerd-backend:
    image: usenerd-backend:latest
    environment:
      # Database
      - DATABASE_URL=postgresql://usenerd:${POSTGRES_PASSWORD:-changeme123}@usenerd-postgres:5432/usenerd_production?sslmode=disable
      # Redis
      - REDIS_URL=redis://:${REDIS_PASSWORD:-changeme123}@usenerd-redis:6379
      # CORS (production domains)
      - STORE_CORS=https://usenerd.com,https://www.usenerd.com
      - ADMIN_CORS=https://admin.usenerd.com
      - AUTH_CORS=https://admin.usenerd.com,https://usenerd.com,https://www.usenerd.com
      # Secrets (CHANGE IN PRODUCTION!)
      - JWT_SECRET=${JWT_SECRET}
      - COOKIE_SECRET=${COOKIE_SECRET}
      # Node Environment
      - NODE_ENV=production
      - LOG_LEVEL=info
      - PORT=9000
      # Printful Configuration (empty for now, fill later)
      - PRINTFUL_ACCESS_TOKEN=${PRINTFUL_ACCESS_TOKEN:-}
      - PRINTFUL_STORE_ID=${PRINTFUL_STORE_ID:-}
      - PRINTFUL_LOGO_URL=${PRINTFUL_LOGO_URL:-}
      - PRINTFUL_BACKEND_URL=https://api.usenerd.com
      - PRINTFUL_CONFIRM_ORDER=${PRINTFUL_CONFIRM_ORDER:-false}
      - PRINTFUL_ENABLE_WEBHOOKS=${PRINTFUL_ENABLE_WEBHOOKS:-false}
    networks:
      - network_public
    volumes:
      - usenerd_medusa_uploads:/app/uploads
      - usenerd_medusa_build:/app/.medusa
    depends_on:
      - usenerd-postgres
      - usenerd-redis
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        # Traefik Configuration
        - "traefik.enable=true"
        - "traefik.docker.network=network_public"

        # API Router (api.usenerd.com)
        - "traefik.http.routers.usenerd-api.rule=Host(`api.usenerd.com`)"
        - "traefik.http.routers.usenerd-api.entrypoints=websecure"
        - "traefik.http.routers.usenerd-api.tls.certresolver=letsencrypt"
        - "traefik.http.routers.usenerd-api.service=usenerd-api"
        - "traefik.http.services.usenerd-api.loadbalancer.server.port=9000"

        # Admin Router (admin.usenerd.com)
        - "traefik.http.routers.usenerd-admin.rule=Host(`admin.usenerd.com`)"
        - "traefik.http.routers.usenerd-admin.entrypoints=websecure"
        - "traefik.http.routers.usenerd-admin.tls.certresolver=letsencrypt"
        - "traefik.http.routers.usenerd-admin.service=usenerd-admin"
        - "traefik.http.services.usenerd-admin.loadbalancer.server.port=9000"

        # Stack Namespace
        - "com.docker.stack.namespace=usenerd"

  # ============================================
  # Next.js Storefront
  # ============================================
  usenerd-storefront:
    image: usenerd-storefront:latest
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_MEDUSA_BACKEND_URL=https://api.usenerd.com
      - NEXT_PUBLIC_BASE_URL=https://usenerd.com
      - NEXT_PUBLIC_STRAPI_URL=https://cms.usenerd.com
      - PORT=3000
    networks:
      - network_public
    depends_on:
      - usenerd-backend
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        # Traefik Configuration
        - "traefik.enable=true"
        - "traefik.docker.network=network_public"

        # Main Domain Router (usenerd.com + www.usenerd.com)
        - "traefik.http.routers.usenerd-web.rule=Host(`usenerd.com`) || Host(`www.usenerd.com`)"
        - "traefik.http.routers.usenerd-web.entrypoints=websecure"
        - "traefik.http.routers.usenerd-web.tls.certresolver=letsencrypt"
        - "traefik.http.routers.usenerd-web.service=usenerd-web"
        - "traefik.http.services.usenerd-web.loadbalancer.server.port=3000"

        # WWW to non-WWW redirect middleware
        - "traefik.http.middlewares.usenerd-redirect-www.redirectregex.regex=^https://www\\.usenerd\\.com/(.*)"
        - "traefik.http.middlewares.usenerd-redirect-www.redirectregex.replacement=https://usenerd.com/$${1}"
        - "traefik.http.middlewares.usenerd-redirect-www.redirectregex.permanent=true"
        - "traefik.http.routers.usenerd-web.middlewares=usenerd-redirect-www@docker"

        # Stack Namespace
        - "com.docker.stack.namespace=usenerd"

  # ============================================
  # Strapi CMS
  # ============================================
  usenerd-strapi:
    image: usenerd-strapi:latest
    environment:
      # Database Configuration
      - DATABASE_HOST=usenerd-postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=usenerd_production
      - DATABASE_USERNAME=usenerd
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-changeme123}
      - DATABASE_SCHEMA=strapi
      - DATABASE_SSL=false
      # Server Configuration
      - HOST=0.0.0.0
      - PORT=1337
      - NODE_ENV=production
      # Strapi Secrets (MUST be set in .env)
      - APP_KEYS=${APP_KEYS}
      - API_TOKEN_SALT=${API_TOKEN_SALT}
      - ADMIN_JWT_SECRET=${ADMIN_JWT_SECRET}
      - TRANSFER_TOKEN_SALT=${TRANSFER_TOKEN_SALT}
      # Public URL
      - STRAPI_URL=https://cms.usenerd.com
    volumes:
      - usenerd_strapi_uploads:/app/public/uploads
    networks:
      - network_public
    depends_on:
      - usenerd-postgres
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        # Traefik Configuration
        - "traefik.enable=true"
        - "traefik.docker.network=network_public"

        # CMS Router (cms.usenerd.com)
        - "traefik.http.routers.usenerd-cms.rule=Host(`cms.usenerd.com`)"
        - "traefik.http.routers.usenerd-cms.entrypoints=websecure"
        - "traefik.http.routers.usenerd-cms.tls.certresolver=letsencrypt"
        - "traefik.http.routers.usenerd-cms.service=usenerd-cms"
        - "traefik.http.services.usenerd-cms.loadbalancer.server.port=1337"

        # Stack Namespace
        - "com.docker.stack.namespace=usenerd"

# ============================================
# Networks
# ============================================
networks:
  network_public:
    external: true

# ============================================
# Volumes
# ============================================
volumes:
  usenerd_postgres_data:
    driver: local
  usenerd_redis_data:
    driver: local
  usenerd_medusa_uploads:
    driver: local
  usenerd_medusa_build:
    driver: local
  usenerd_strapi_uploads:
    driver: local
