version: '3.8'

# ============================================
# USE Nerd - Web-Accessible Docker Compose
# Development images + Traefik labels = Web access
# ============================================

services:
  # ============================================
  # PostgreSQL Database
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: usenerd-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: usenerd
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-UsEN3rd_DB_Prod_2025!}
      POSTGRES_DB: usenerd_production
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - usenerd-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U usenerd"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Redis Cache
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: usenerd-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-UsEN3rd_Redis_Prod_2025!}
    volumes:
      - redis_data:/data
    networks:
      - usenerd-network
    healthcheck:
      test: ["CMD", "redis-cli", "--pass", "${REDIS_PASSWORD:-UsEN3rd_Redis_Prod_2025!}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ============================================
  # Medusa Backend (Development mode)
  # ============================================
  medusa-backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: usenerd-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./src:/app/src
      - ./medusa-config.production.ts:/app/medusa-config.ts
      - medusa_build:/app/.medusa
      - medusa_uploads:/app/uploads
    environment:
      - DATABASE_URL=postgresql://usenerd:${POSTGRES_PASSWORD:-UsEN3rd_DB_Prod_2025!}@postgres:5432/usenerd_production?sslmode=disable
      - REDIS_URL=redis://:${REDIS_PASSWORD:-UsEN3rd_Redis_Prod_2025!}@redis:6379
      - STORE_CORS=https://usenerd.com,https://www.usenerd.com
      - ADMIN_CORS=https://admin.usenerd.com
      - AUTH_CORS=https://admin.usenerd.com,https://usenerd.com,https://www.usenerd.com
      - JWT_SECRET=${JWT_SECRET}
      - COOKIE_SECRET=${COOKIE_SECRET}
      - NODE_ENV=production
      - LOG_LEVEL=info
      - PORT=9000
    networks:
      - usenerd-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=usenerd-network"

      # API Router (api.usenerd.com)
      - "traefik.http.routers.usenerd-api.rule=Host(`api.usenerd.com`)"
      - "traefik.http.routers.usenerd-api.entrypoints=websecure"
      - "traefik.http.routers.usenerd-api.tls=true"
      - "traefik.http.routers.usenerd-api.tls.certresolver=letsencryptresolver"
      - "traefik.http.routers.usenerd-api.service=usenerd-api"
      - "traefik.http.services.usenerd-api.loadbalancer.server.port=9000"

      # Admin Router (admin.usenerd.com)
      - "traefik.http.routers.usenerd-admin.rule=Host(`admin.usenerd.com`)"
      - "traefik.http.routers.usenerd-admin.entrypoints=websecure"
      - "traefik.http.routers.usenerd-admin.tls=true"
      - "traefik.http.routers.usenerd-admin.tls.certresolver=letsencryptresolver"
      - "traefik.http.routers.usenerd-admin.service=usenerd-admin"
      - "traefik.http.services.usenerd-admin.loadbalancer.server.port=9000"

  # ============================================
  # Strapi CMS (Development mode)
  # ============================================
  strapi-cms:
    build:
      context: ./strapi-cms
      dockerfile: Dockerfile
      target: development
    container_name: usenerd-strapi
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./strapi-cms/src:/app/src
      - ./strapi-cms/config:/app/config
      - strapi_uploads:/app/public/uploads
    environment:
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=usenerd_production
      - DATABASE_USERNAME=usenerd
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-UsEN3rd_DB_Prod_2025!}
      - DATABASE_SCHEMA=strapi
      - DATABASE_SSL=false
      - HOST=0.0.0.0
      - PORT=1337
      - NODE_ENV=production
      - APP_KEYS=${APP_KEYS}
      - API_TOKEN_SALT=${API_TOKEN_SALT}
      - ADMIN_JWT_SECRET=${ADMIN_JWT_SECRET}
      - TRANSFER_TOKEN_SALT=${TRANSFER_TOKEN_SALT}
      - STRAPI_URL=https://cms.usenerd.com
    networks:
      - usenerd-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=usenerd-network"

      # CMS Router (cms.usenerd.com)
      - "traefik.http.routers.usenerd-cms.rule=Host(`cms.usenerd.com`)"
      - "traefik.http.routers.usenerd-cms.entrypoints=websecure"
      - "traefik.http.routers.usenerd-cms.tls=true"
      - "traefik.http.routers.usenerd-cms.tls.certresolver=letsencryptresolver"
      - "traefik.http.routers.usenerd-cms.service=usenerd-cms"
      - "traefik.http.services.usenerd-cms.loadbalancer.server.port=1337"

# Note: Storefront will be added in next phase
# For now, testing backend + CMS only

# ============================================
# Networks
# ============================================
networks:
  usenerd-network:
    driver: bridge
    name: usenerd-network

# ============================================
# Volumes
# ============================================
volumes:
  postgres_data:
    driver: local
    name: usenerd-postgres-data
  redis_data:
    driver: local
    name: usenerd-redis-data
  medusa_build:
    driver: local
    name: usenerd-medusa-build
  medusa_uploads:
    driver: local
    name: usenerd-medusa-uploads
  strapi_uploads:
    driver: local
    name: usenerd-strapi-uploads
